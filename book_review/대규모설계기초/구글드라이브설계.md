> 구글 드라이브 설계
>
- 구글 드라이브란?

  파일 저장 및 동기화 서비스. 파일을 클라우드에 보관 가능


### 요구사항 이해

필요한 기능

- 파일 추가, 다운로드
- 여러 단말에 파일 동기화
- 파일 갱신 이력 조회
- 파일 공유
- 파일 편집 /삭제시 알림표시

필요한 장비

- 파일을 올리고 다운로드 하는 과정을 처리할 웹 서버
- 사용자 데이터, 로그인 정보 등 메타데이터를 보관할 데이터베이스
- 파일을 저장할 저장소 시스템

1. API
- 파일 업로드 API
    - 단순 업로드 - 파일 크기가 작을때
    - 이어 올리기 - 크고, 중간에 중단될 가능성이 높을 때
        - uploadType=resumable
- 파일 다운로드 API
- 파일 갱신 히스토리 API

→ 모든 API는 SSL 프로토콜로 보안 필요

발생 문제

: 서버를 한대로 놔서는 언젠간 파일 시스템이 가득 참
a. 데이터 샤딩 (여러 서버에 나눠 저장)
→ 규모 확장

b. 네트워크 로드 벨런싱
→ 장애 대비

c. 메타데이터 데이터베이스
→ 가용성, 규모 확장 대비

d. 파일 저장소 다중화
→ 가용성, 데이터 무손실 보장

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/780f5036-3abf-411a-b015-07875839974f/Untitled.png)

동기화 이슈

: 동시에 한 파일에 두 사용자가 접근했을 경우 뒤에 접근한 사용자는 오류가 뜨며 로컬 사본을 가지게 됨

⇒ 두 파일을 하나로 합칠지, 둘 중 하나를 대체할지 결정해야함

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/f5b4b6a5-f666-4e32-bd6c-b70b0e2da49d/Untitled.png)

블록 저장소 서버 - 파일 블록을 클라우드 저장소에 업로드하는 서버
: 파일을 여러개의 블록으로 나눠 저장(해시값을 만들고 그걸 메타데이터 데이터베이스에 저장)

아카이빙 저장소 : 비활성 데이터 저장

오프라인 사용자 백업 큐 : 클라이언트가 접속됐을때 동기화할수 있도록 쌓음

### 상세 설계

- 블록 저장소 서버

  : 정기적으로 갱신될때 전체파일이 한번에 업데이트가 되면 서버 네트워크 부하

- 델타 동기화 : 파일이 수정되면 전체 파일 대신 수정이 일어난 블록만 동기화
- 압축 : 블록단위로 압축하여 데이터 크기 줄이기

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/20488ada-1bbf-4ae8-8b29-e97d1f8fe81e/Untitled.png)

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/f65effc5-494d-42e9-922f-1371f687d879/Untitled.png)

- 높은 일관성 요구사항

  : 단말 / 사용자에 따라 다르게 보이면 안되므로

데이터베이스(원본)에 변경이 생기면 캐시(사본) 무효화

- 메타데이터 데이터베이스

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/e778ca5a-29ad-4eb8-aae8-62e1ad088ca8/Untitled.png)

블록에 대한 정보도 보관

- 업로드 절차

업로드시, 파일 메타데이터 추가 요청 + 클라우드 저장소로 업로드 가 동시에 진행

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/c3131baa-f055-4c62-b7aa-c2bf9b065bbf/Untitled.png)

파일 업로드 요청도 메타데이터 데이터베이스에게 완료 상태로 변경했음을 알려야함(여게서는 콜백 호출을 API 로 전송)

- 다운로드 절차

  : 파일이 추가, 변집되면 자동으로 시작

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/e13ee5a8-5f5c-4d1a-b1ff-166edbcc7b06/Untitled.png)

- 알림서비스

  : 파일이 수정되었음을 알림

1. **롱 폴링** - 클라이언트의 요청에 대해서 서버가 일정시간동안 기다렸다가 클라이언트에게 응답을 주는 방식
2. 웹 소켓 - 클라이언트와 서버 사이에 지속적인 통신 채널 제공

양방향 통신이 필요없으므로 롱 폴링 연결 사용

- 저장소 공간 절약

  : 파일의 여러 버전을 여러 데이터 센터에 보관할 필요가 있음

- 중복 제거 (블록의 해시값을 비교하여 판단)
- 지능적 백업 전략 (한도설정, 중요 버전만 보관..)
- 아카이빙 저장소로 옮김

- 장애처리
    - 로드밸런서 장애
        - 부 로드밸런서가 활성화되어 트래픽 이어받아야함
    - 블록 저장소 서버 장애
        - 다른 블록 저장소가 작업 이어받아야
    - API 서버 장애
        - 무상태 서버이므로 장애가 발생하면 로드밸런서가 해당 서버로 보내지 않음
    - 메타데이터 캐시 장애 → 다중화(다른 노드에서 데이터 가져올 수 있음)
    - 메타데이터 데이터베이스 장애
        - 주 : 부 중 하나를 주로 올림. 부 서버 하나 더 추가
        - 부 : 다른 부가 읽기 연산처리. 부 서버 교체
    - 알림 서비스 장애

      : 모든 접속중인 사용자는 알림 서버와 롱 폴링 연결을 하나씩 유지

      → 한 대 서버에 장애가 발생하면 백만 명 이상의 사용자가 롱 폴링 연결을 다시 만들어야함(동시에 불가. 느림)

    - 오프라인 사용자 백업 큐 장애 : 다중화 필요. 백업 큐로 구독 관계 재설정