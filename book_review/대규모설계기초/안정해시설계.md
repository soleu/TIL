> 5장. 안정 해시 설계
>

: 수평적 규모 확장성을 달성하기 위해 요청 또는 데이터를 서버에 균등하게 나누는 것

### 해시 키 재배치(rehash) 문제

`searverIndex = hash(key) % N (N = 서버 개수)`

특정 키를 서버 개수를 통해 분산하고, 보관된 키는 나머지 연산을 통해 어디에 들어있는지 알아낼 수 있음

- 특징
    - 서버 풀의 크기가 고정되어 있을 때, 데이터 분포가 균등할 때 잘 동작
    - 서버가 추가/삭제 되면 문제 발생 (→ 나머지 연산이 안먹힘)


### 안정해시 (consistent hash)

: 해시 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술(k = 키의 개수, n = 슬롯의 개수)

(기존에는 슬롯 수가 바뀌면 키를 재배치)

- 해시 공간과 해시 링
    - 해시 공간 - 물리적인 공간

      ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/07368ce0-597f-4d8e-b81e-141baa477a8f/Untitled.png)

    - 해시링

  ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/b4996002-7539-4ce4-a114-6ef53e359438/Untitled.png)


해시서버 : 해시 함수를 이용하여 서버 IP/이름을 링 위의 어떤 위치에 대응할 수 있음

해시 키 : 해시 키 또한 해시 링 위의 어느 지점에 배치 할 수 있음

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/f12840d5-050e-471e-a233-b463025394ae/Untitled.png)

- 서버 CRUD
    - 서버 조회
        - 시계 방향으로 링을 탐색해 나가면서 만나는 첫 번째 서버에 키를 저장
    - 서버 추가
        - 키 가운데 일부만 재배치
        - 서버 오른쪽에 있는 키를 받을지만 결정
    - 서버 제거
        - 키 가운데 일부만 재배치
        - 시계방향 다음 노드로 변경

- 기본 구현법의 두가지 문제
    - 기본 절차
        - 서버와 키를 균등 분포하여 해시 링에 배치
        - 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버
    - 문제점
        1. 서버 추가/삭제가 되는 상황에서 파티션(partition)의 크기를 균등하게 유지하는게 불가
            - 파티션 : 인접한 서버 사이의 해시 공간
              (삭제가 되면서 키 - 서버의 거리가 멀어지게 되고, 파티션이 그만큼 넓어짐)
        2. 키의 균등 분포를 달성하기가 어려움
            - 모든 서버가 같은 양의 키를 갖는게 아니라 키의 위치에 따라 균등 분포가 안될 수 있음

- 해결 방안 - 가상노드

  : 실제 노드 또는 서버를 가리키는 노드, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있음

  ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/4eb17d17-9fd9-456b-9cd6-805a7036e822/8710f785-51fb-476d-9794-abe24757ed60/Untitled.png)

  서버 0, 서버 1은 3개의 가상 노드를 가짐

  → 각 서버는 하나가 아닌 여러 개 파티션을 관리해야 함

    - 가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해짐
      why? 표준 편자가 작아져서 데이터가 고르게 분포되기 때문

      but, 가상 노드의 개수를 늘리면 가상 노드 데이터를 저장할 공간이 더 많이 필요하게 됨

    - 재배치할 키 결정

  → 추가 : 기존 서버 부터 새로 배치할 서버사이에 시계 방향으로 키만 재배치하면 됨

  → 삭제 : 기존 서버 부터 새로 배치할 서버사이에 반시계 방향으로 키만 재배치하면 됨


- 안정 해시의 이점
    - 서버 추가/삭제시 재배치되는 키의 수 최소화
    - 데이터가 균등하게 분포되므로 수평적 규모 확장성 달성하기 쉬움
    - 핫스팟 키 문제 줄임(셀러브리티 문제)